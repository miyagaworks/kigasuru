# iOS Safari PWA認証ガイド

## iOS PWAでOAuth認証エラーが発生する場合

### 原因

iOS Safari PWAは以下の制限があります：
- ポップアップウィンドウの制限
- セッションCookieの分離
- サードパーティCookieのブロック
- Web Storage APIの制限

### 解決方法

## 方法1: PWAの完全リセット（推奨）

1. **ホーム画面からPWAアプリを削除**
   - アイコンを長押し → 「Appを削除」

2. **Safariのデータをクリア**
   ```
   設定 → Safari → 履歴とWebサイトデータを消去
   ```

3. **Safariブラウザでログイン**
   - https://app.kigasuru.com にアクセス
   - Google/LINEでログイン
   - ダッシュボードが表示されることを確認

4. **PWAを再インストール**
   - ログイン済みの状態で共有ボタン → ホーム画面に追加
   - PWAアプリを開いてログイン状態が維持されていることを確認

## 方法2: 代替認証フロー

PWA内で認証エラーが続く場合：

1. **メールアドレス認証を使用**
   - OAuth認証の代わりにメール/パスワードでログイン

2. **ブラウザで認証後、PWAで使用**
   - Safariブラウザでログイン → PWAをインストール

## 技術的な詳細

### iOS PWAのセッション管理

iOS 15以降、PWAのセッションはブラウザから分離されています：
- PWA内のCookieはブラウザと共有されない
- OAuth認証後のセッションが正しく保存されない場合がある

### デバッグ方法

1. **PWA内でデバッグモードを有効化**
   ```
   PWAアプリ内で以下のURLにアクセス：
   /auth/signin?debug=true
   ```

2. **Mac Safariでデバッグ**
   - iPhone: 設定 → Safari → 詳細 → Webインスペクタをオン
   - Mac: Safari → 開発メニューでiPhoneを選択
   - コンソールログを確認

### 一時的な回避策

1. **認証キープアライブ**
   - 定期的にセッション確認を行い、期限切れ前に更新

2. **リフレッシュトークンの活用**
   - OAuth認証時にrefresh_tokenを取得・保存

3. **Service Workerでのセッション管理**
   - IndexedDBを使用してトークンを永続化

## トラブルシューティング

### 「認証エラー」が表示される場合

1. **ポップアップブロッカーを確認**
   - 設定 → Safari → ポップアップブロック → オフ

2. **プライベートブラウズモードを確認**
   - プライベートモードではPWAは機能しません

3. **iOS/iPadOSのバージョンを確認**
   - iOS 16.4以降を推奨

### それでも解決しない場合

1. **iOSを最新版にアップデート**
2. **別のブラウザ（Chrome）を試す**
3. **開発チームに報告**
   - デバイス情報
   - iOSバージョン
   - エラーメッセージのスクリーンショット

---

## 今後の改善予定

- iOS PWA専用の認証フロー実装
- ASWebAuthenticationSessionの導入検討
- PWA内での直接認証サポート